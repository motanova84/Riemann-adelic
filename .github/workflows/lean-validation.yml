name: ðŸ”Ž Lean 4 Validation & Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-lean:
    name: "ðŸ§  FormalizaciÃ³n Riemannâ€“Adelic (Lean 4.5.0)"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # 1ï¸âƒ£  Clonar el repositorio
    - name: ðŸ”½ Checkout repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£  Configurar Python (para el validador)
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3ï¸âƒ£  Configurar Lean (via elan)
    - name: âš™ï¸ Set up Lean toolchain
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: âš™ï¸ Configure Lean version
      run: |
        elan default stable
        lean --version

    # 4ï¸âƒ£  Generar lake-manifest.json
    - name: ðŸ“¦ Generate lake manifest
      working-directory: formalization/lean
      run: |
        lake update

    # 5ï¸âƒ£  Cache Lake packages
    - name: ðŸ’¾ Cache Lake packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.elan
          formalization/lean/.lake
          formalization/lean/lake-packages
        key: ${{ runner.os }}-lake-${{ hashFiles('formalization/lean/lakefile.lean') }}
        restore-keys: |
          ${{ runner.os }}-lake-

    # 6ï¸âƒ£  Ir al directorio de formalizaciÃ³n
    - name: ðŸ“‚ Navigate to Lean formalization folder
      working-directory: formalization/lean
      run: |
        echo "Contenido actual:"
        ls -la

    # 7ï¸âƒ£  Compilar el proyecto
    - name: ðŸ”¨ Build project
      id: build
      continue-on-error: true
      timeout-minutes: 45
      working-directory: formalization/lean
      run: |
        START_TIME=$(date +%s)
        echo "ðŸ”¨ Building project..."
        BUILD_EXIT=0
        lake build || BUILD_EXIT=$?
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "build_exit=$BUILD_EXIT" >> $GITHUB_OUTPUT
        if [ $BUILD_EXIT -eq 0 ]; then
          echo "status=PASS" >> $GITHUB_OUTPUT
        else
          echo "status=CHECK" >> $GITHUB_OUTPUT
        fi

    # 8ï¸âƒ£  Validar el entorno Lean con Python
    - name: ðŸ§ª Run Python validation script
      working-directory: formalization/lean
      run: |
        python3 validate_lean_env.py || echo "Validation script had issues"
        cat validation_report.json || echo "No validation report generated"

    # 9ï¸âƒ£  Subir el informe JSON como artefacto
    - name: ðŸ“¤ Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: formalization/lean/validation_report.json

    # ðŸ”Ÿ  Publicar resumen en la interfaz de GitHub Actions
    - name: ðŸ§¾ Display summary
      if: always()
      run: |
        echo "### Riemannâ€“Adelic Lean Validation Summary ðŸ§ " >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f formalization/lean/validation_report.json ]; then
          cat formalization/lean/validation_report.json | jq -r '"âœ… Status: \(.summary.status // "UNKNOWN")\nðŸ§® Build Time: \(.build_time_sec // 0)s\nâš ï¸ Warnings: \(.warnings // 0)\nâŒ Errors: \(.errors // 0)"' >> $GITHUB_STEP_SUMMARY || echo "Could not parse validation report" >> $GITHUB_STEP_SUMMARY
        else
          echo "No validation report available" >> $GITHUB_STEP_SUMMARY
        fi
