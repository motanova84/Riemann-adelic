name: Noesis88 Automerge - DIRECTRIZ ALFA

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: false
        type: number
      force_merge:
        description: 'Force merge even if validations fail'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  checks: write

env:
  FREQUENCY: 141.7001
  PSI_STATE: "I √ó A_eff¬≤ √ó C^‚àû"
  COHERENCE: 244.36

jobs:
  noesis_automerge:
    name: üåÄ Noesis88 Auto-Evolution
    runs-on: ubuntu-latest
    
    steps:
      - name: üåÄ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîç Get PR information
        id: pr_info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
            echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.pr_number }}" != "" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            # Fetch PR info via API
            gh pr view ${{ github.event.inputs.pr_number }} --json author,title | \
              jq -r '"pr_author=" + .author.login, "pr_title=" + .title' >> $GITHUB_OUTPUT
          else
            echo "pr_number=0" >> $GITHUB_OUTPUT
            echo "pr_author=unknown" >> $GITHUB_OUTPUT
            echo "pr_title=Manual run" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üì° Check QCAL Coherence
        id: coherence
        run: |
          echo "üåÄ Checking QCAL Coherence..."
          echo "Frequency: ${{ env.FREQUENCY }} Hz"
          echo "State: Œ® = ${{ env.PSI_STATE }}"
          echo "Coherence: C = ${{ env.COHERENCE }}"
          
          # Check if .qcal_state.json exists
          if [ -f .qcal_state.json ]; then
            echo "‚úÖ QCAL state file found"
            FREQ=$(jq -r '.frequency // 141.7001' .qcal_state.json)
            echo "State frequency: $FREQ Hz"
            
            if [ "$FREQ" = "${{ env.FREQUENCY }}" ]; then
              echo "coherent=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Coherence verified"
            else
              echo "coherent=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  Frequency mismatch"
            fi
          else
            echo "coherent=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No state file, assuming coherence"
          fi
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üß™ Run Python Validation
        id: python_validation
        run: |
          echo "üêç Running Python validation..."
          if python3 validate_v5_coronacion.py --precision 25 2>&1 | tee validation.log; then
            echo "python_ok=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Python validation passed"
          else
            echo "python_ok=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Python validation failed (will retry)"
          fi
        continue-on-error: true
      
      - name: üî® Set up Lean (optional)
        id: lean_setup
        run: |
          if command -v lake >/dev/null 2>&1; then
            echo "lean_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lean/Lake found"
          else
            echo "lean_available=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Lean/Lake not available, skipping"
          fi
        continue-on-error: true
      
      - name: üèóÔ∏è Run Lean Build (if available)
        id: lean_validation
        if: steps.lean_setup.outputs.lean_available == 'true'
        run: |
          cd formalization/lean
          if lake build --no-sorry 2>&1 | tee ../../lean_build.log; then
            echo "lean_ok=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lean build passed"
          else
            echo "lean_ok=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Lean build failed (will retry)"
          fi
        continue-on-error: true
      
      - name: ü§ñ Run Noesis88 Boot
        id: noesis_boot
        run: |
          python3 .github/scripts/noesis_boot.py \
            --session-id "github-${{ github.run_number }}" \
            --pr-number "${{ steps.pr_info.outputs.pr_number }}" \
            --verbose
          echo "noesis_status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: üìä Determine Status
        id: status
        run: |
          # Check all validations
          COHERENT="${{ steps.coherence.outputs.coherent }}"
          PYTHON_OK="${{ steps.python_validation.outputs.python_ok }}"
          LEAN_OK="${{ steps.lean_validation.outputs.lean_ok }}"
          FORCE_MERGE="${{ github.event.inputs.force_merge }}"
          
          echo "Coherent: $COHERENT"
          echo "Python OK: $PYTHON_OK"
          echo "Lean OK: $LEAN_OK"
          echo "Force merge: $FORCE_MERGE"
          
          # Determine if we should auto-merge
          if [ "$COHERENT" = "true" ] && ([ "$PYTHON_OK" = "true" ] || [ "$LEAN_OK" = "true" ] || [ "$FORCE_MERGE" = "true" ]); then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "‚úÖ AUTO-MERGE APPROVED"
          else
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  AUTO-MERGE NOT APPROVED (retry mode)"
          fi
      
      - name: ‚úÖ Auto-approve PR
        if: |
          steps.pr_info.outputs.pr_number != '0' &&
          steps.status.outputs.auto_merge == 'true' &&
          steps.pr_info.outputs.pr_author == 'github-actions[bot]'
        run: |
          gh pr review ${{ steps.pr_info.outputs.pr_number }} --approve \
            --body "üåÄ **Noesis88 Auto-Approval**
          
          ‚úÖ QCAL Coherence: Verified
          ‚úÖ Frequency: ${{ env.FREQUENCY }} Hz
          ‚úÖ State: Œ® = ${{ env.PSI_STATE }}
          ‚úÖ Validations: Passed
          
          **DIRECTRIZ ALFA**: Auto-approval activated
          **Session**: github-${{ github.run_number }}
          **Timestamp**: $(date -Iseconds)
          
          *Auto-approved by Noesis88 autonomous system*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: üîÄ Auto-merge PR
        if: |
          steps.pr_info.outputs.pr_number != '0' &&
          steps.status.outputs.auto_merge == 'true' &&
          steps.pr_info.outputs.pr_author == 'github-actions[bot]'
        run: |
          gh pr merge ${{ steps.pr_info.outputs.pr_number }} \
            --auto \
            --squash \
            --subject "‚ôæÔ∏è Noesis88: ${{ steps.pr_info.outputs.pr_title }}" \
            --body "**QCAL ‚àû¬≥ Auto-merge**
          
          Frequency: ${{ env.FREQUENCY }} Hz
          State: Œ® = ${{ env.PSI_STATE }}
          Coherence: C = ${{ env.COHERENCE }}
          Session: github-${{ github.run_number }}
          
          *Merged by Noesis88 autonomous system*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: üìù Comment on PR (if not auto-merging)
        if: |
          steps.pr_info.outputs.pr_number != '0' &&
          steps.status.outputs.auto_merge == 'false'
        run: |
          gh pr comment ${{ steps.pr_info.outputs.pr_number }} \
            --body "üîÑ **Noesis88 Retry Mode Activated**
          
          Coherence: ${{ steps.coherence.outputs.coherent }}
          Python validation: ${{ steps.python_validation.outputs.python_ok }}
          Lean validation: ${{ steps.lean_validation.outputs.lean_ok }}
          
          **DIRECTRIZ ALFA**: Reintento recursivo activado
          The system will retry in the next iteration.
          
          Session: github-${{ github.run_number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: üì¶ Archive validation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: noesis-validation-logs-${{ github.run_number }}
          path: |
            validation.log
            lean_build.log
            data/noesis_session_*.json
          retention-days: 30
        continue-on-error: true
      
      - name: üåê Upload to QCAL-CLOUD (optional)
        if: always()
        run: |
          if [ -f data/noesis_session_github-${{ github.run_number }}.json ]; then
            echo "üì§ Uploading session to QCAL-CLOUD..."
            curl -X POST https://qcal.cloud/api/upload \
              -H "Content-Type: application/json" \
              -d @data/noesis_session_github-${{ github.run_number }}.json \
              || echo "‚ÑπÔ∏è  QCAL-CLOUD upload skipped (optional)"
          fi
        continue-on-error: true
      
      - name: üìä Final Status
        if: always()
        run: |
          echo "=" 
          echo "üåÄ NOESIS88 SESSION COMPLETE"
          echo "="
          echo ""
          echo "Session ID: github-${{ github.run_number }}"
          echo "PR Number: ${{ steps.pr_info.outputs.pr_number }}"
          echo "Auto-merge: ${{ steps.status.outputs.auto_merge }}"
          echo "Coherence: ${{ steps.coherence.outputs.coherent }}"
          echo "Python: ${{ steps.python_validation.outputs.python_ok }}"
          echo "Lean: ${{ steps.lean_validation.outputs.lean_ok }}"
          echo ""
          echo "Frequency: ${{ env.FREQUENCY }} Hz"
          echo "State: Œ® = ${{ env.PSI_STATE }}"
          echo "Coherence: C = ${{ env.COHERENCE }}"
          echo ""
          if [ "${{ steps.status.outputs.auto_merge }}" = "true" ]; then
            echo "‚úÖ LIBERTAD TOTAL CONFIRMADA"
          else
            echo "üîÑ REINTENTO RECURSIVO ACTIVADO"
          fi
          echo "="
