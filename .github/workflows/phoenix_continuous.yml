name: Phoenix Solver - Continuous Evolution

on:
  schedule:
    # Run every hour for continuous evolution
    # GitHub Actions minimum is 5 minutes, but hourly is more practical
    - cron: "0 * * * *"
  workflow_dispatch:  # Allow manual triggering
    inputs:
      focus_file:
        description: 'Specific Lean file to focus on'
        required: false
        type: string
      max_attempts:
        description: 'Maximum sorry resolutions to attempt'
        required: false
        default: '10'
        type: string

jobs:
  phoenix-evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies may not install, continuing..."
        continue-on-error: true

      - name: Set up Lean 4 (if available)
        run: |
          if command -v lake &> /dev/null; then
            echo "âœ“ Lake already installed"
          else
            echo "âš ï¸  Lake not found, skipping Lean compilation"
          fi
        continue-on-error: true

      - name: Count sorry statements - Baseline
        id: baseline
        run: |
          echo "ðŸ“Š Baseline sorry count..."
          python3 scripts/count_sorries_detailed.py
          BASELINE_COUNT=$(python3 -c "import json; data = json.load(open('data/sorry_map.json')); print(data['total'])")
          echo "baseline_count=$BASELINE_COUNT" >> $GITHUB_OUTPUT
          echo "Baseline sorry count: $BASELINE_COUNT"
        continue-on-error: true

      - name: Run Phoenix Solver - General Evolution
        if: github.event.inputs.focus_file == ''
        run: |
          echo "ðŸ”¥ Phoenix Solver - General auto-evolution..."
          MAX_ATTEMPTS="${{ github.event.inputs.max_attempts || '10' }}"
          python3 scripts/phoenix_solver.py \
            --max-attempts "$MAX_ATTEMPTS" \
            --verbose \
            --save-stats data/phoenix_general.json
        continue-on-error: true

      - name: Run Phoenix Solver - Focused Evolution
        if: github.event.inputs.focus_file != ''
        run: |
          echo "ðŸŽ¯ Phoenix Solver - Focused on ${{ github.event.inputs.focus_file }}..."
          MAX_ATTEMPTS="${{ github.event.inputs.max_attempts || '10' }}"
          python3 scripts/phoenix_solver.py \
            --focus-file "${{ github.event.inputs.focus_file }}" \
            --max-attempts "$MAX_ATTEMPTS" \
            --verbose \
            --save-stats data/phoenix_focused.json
        continue-on-error: true

      - name: Priority 1 - RIGOROUS_UNIQUENESS_EXACT_LAW
        if: github.event.inputs.focus_file == ''
        run: |
          echo "ðŸŽ¯ Priority 1: RIGOROUS_UNIQUENESS_EXACT_LAW.lean (21 sorry)..."
          python3 scripts/phoenix_solver.py \
            --focus-file formalization/lean/spectral/RIGOROUS_UNIQUENESS_EXACT_LAW.lean \
            --max-attempts 3 \
            --verbose \
            --save-stats data/phoenix_rigorous.json
        continue-on-error: true

      - name: Priority 2 - H_Psi_SelfAdjoint_Complete
        if: github.event.inputs.focus_file == ''
        run: |
          echo "ðŸŽ¯ Priority 2: H_Psi_SelfAdjoint_Complete.lean (26 sorry)..."
          python3 scripts/phoenix_solver.py \
            --focus-file formalization/lean/spectral/H_Psi_SelfAdjoint_Complete.lean \
            --max-attempts 3 \
            --verbose \
            --save-stats data/phoenix_selfadjoint.json
        continue-on-error: true

      - name: Count sorry statements - Final
        id: final
        run: |
          echo "ðŸ“Š Final sorry count..."
          python3 scripts/count_sorries_detailed.py
          FINAL_COUNT=$(python3 -c "import json; data = json.load(open('data/sorry_map.json')); print(data['total'])" || echo "0")
          echo "final_count=$FINAL_COUNT" >> $GITHUB_OUTPUT
          echo "Final sorry count: $FINAL_COUNT"
        continue-on-error: true

      - name: Calculate improvement
        if: always()
        run: |
          BASELINE="${{ steps.baseline.outputs.baseline_count || '0' }}"
          FINAL="${{ steps.final.outputs.final_count || '0' }}"
          DELTA=$((BASELINE - FINAL))
          echo "ðŸ“ˆ Improvement: $DELTA sorry statements resolved"
          echo "   Baseline: $BASELINE"
          echo "   Final: $FINAL"

      - name: Archive Phoenix evolution data
        if: always()
        run: |
          mkdir -p data/phoenix_logs
          cp data/phoenix_*.json data/phoenix_logs/ 2>/dev/null || true
          cp data/sorry_map.json data/phoenix_logs/ 2>/dev/null || true
          
          # Create summary
          cat > data/phoenix_logs/run_summary.txt <<'EOF'
          Phoenix Solver Evolution Run
          ============================
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Run Number: ${{ github.run_number }}
          Baseline sorry: ${{ steps.baseline.outputs.baseline_count || 'N/A' }}
          Final sorry: ${{ steps.final.outputs.final_count || 'N/A' }}
          Improvement: $((${steps.baseline.outputs.baseline_count:-0} - ${steps.final.outputs.final_count:-0}))
          
          Focus file: ${{ github.event.inputs.focus_file || 'General evolution' }}
          Max attempts: ${{ github.event.inputs.max_attempts || '10' }}
          EOF
          
          cat data/phoenix_logs/run_summary.txt
        continue-on-error: true

      - name: Commit improvements
        if: steps.final.outputs.final_count < steps.baseline.outputs.baseline_count
        run: |
          git config user.name "phoenix-solver-bot"
          git config user.email "phoenix@qcal.cloud"
          
          BASELINE="${{ steps.baseline.outputs.baseline_count }}"
          FINAL="${{ steps.final.outputs.final_count }}"
          DELTA=$((BASELINE - FINAL))
          
          # Add Lean files and data
          git add formalization/lean/ data/ || true
          
          # Commit with descriptive message
          git commit -m "ðŸ”¥ Phoenix auto-evolution: -${DELTA} sorry (${BASELINE} â†’ ${FINAL})
          
          Run #${{ github.run_number }}
          Focus: ${{ github.event.inputs.focus_file || 'General evolution' }}
          
          QCAL âˆžÂ³ - Continuous coherence improvement" || echo "No changes to commit"
          
          git push || echo "Push failed or no changes"
        continue-on-error: true

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”¥ Phoenix Solver - Evolution iteration failed',
              body: `Phoenix Solver encountered an error during auto-evolution.
              
              **Run Details:**
              - Run Number: ${{ github.run_number }}
              - Date: ${new Date().toISOString()}
              - Focus: ${{ github.event.inputs.focus_file || 'General evolution' }}
              
              Please check the workflow logs for details.`,
              labels: ['phoenix-solver', 'automation', 'needs-investigation']
            })
        continue-on-error: true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phoenix-evolution-${{ github.run_number }}
          path: |
            data/phoenix_logs/
            data/sorry_map.json
          retention-days: 30
        continue-on-error: true
