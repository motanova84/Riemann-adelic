name: ğŸ§¬ Auto-EvoluciÃ³n QCAL â€“ Lean 4 V5.3 Formalization

on:
  schedule:
    - cron: "0 3 * * *"       # ejecuciÃ³n diaria automÃ¡tica a las 03:00 UTC
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  evolve:
    name: "âœ¨ Auto-EvoluciÃ³n QCAL â€“ ValidaciÃ³n y RegeneraciÃ³n Cognitiva"
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ ObtenciÃ³n del cÃ³digo fuente
    - name: ğŸ§  Clonar repositorio
      uses: actions/checkout@v4
      with:
        ref: main  # Explicitly checkout main branch for scheduled runs

    # 2ï¸âƒ£ ConfiguraciÃ³n del entorno Python + Lean
    - name: ğŸ”§ Configurar entorno base
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: ğŸ“¦ Instalar dependencias del sistema
      run: |
        sudo apt-get update
        # Install LLVM tools for numba/llvmlite
        sudo apt-get install -y llvm-14 llvm-14-dev
        # Install libigraph for python-igraph
        sudo apt-get install -y libigraph-dev libigraph3t64

    - name: ğŸ“¦ Instalar dependencias Python
      env:
        NUMEXPR_MAX_THREADS: 4
        NUMEXPR_NUM_THREADS: 2
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âš™ï¸ Instalar Lean 4.5.0
      run: |
        curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
        export PATH="$HOME/.elan/bin:$PATH"
        if ! command -v elan &> /dev/null; then
          echo "âŒ Elan no estÃ¡ en el PATH"; exit 1
        fi
        elan toolchain install leanprover/lean4:v4.5.0
        elan default leanprover/lean4:v4.5.0
        lean --version
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    # 3ï¸âƒ£ ValidaciÃ³n estructural del sistema
    - name: ğŸ” Validar dependencias del sistema
      run: |
        python3 validate_system_dependencies.py || true

    # 4ï¸âƒ£ ValidaciÃ³n formal Lean
    - name: ğŸ§© Ejecutar validaciÃ³n Lean 4
      working-directory: formalization/lean
      run: |
        python3 validate_lean_env.py || true

    # 5ï¸âƒ£ Generar e integrar informe
    - name: ğŸ“˜ Subir informe de validaciÃ³n
      uses: actions/upload-artifact@v4.1.3
      with:
        name: validation-report
        path: formalization/lean/validation_report.json

    # 6ï¸âƒ£ Actualizar resumen en README
    - name: ğŸ”„ Actualizar resumen en README
      if: success()
      run: |
        REPORT="formalization/lean/validation_report.json"
        if [ -f "$REPORT" ]; then
          STATUS=$(jq -r '.summary.status' $REPORT)
          TIME=$(jq -r '.summary.build_time_sec' $REPORT)
          WARN=$(jq -r '.summary.warnings' $REPORT)
          ERR=$(jq -r '.summary.errors' $REPORT)
          LEANV=$(jq -r '.summary.lean_version' $REPORT)
          DATE=$(date -u +"%Y-%m-%d %H:%M:%SZ")
          
          # Crear la secciÃ³n de Validation Summary si no existe
          if ! grep -q "## Validation Summary" README.md; then
            echo "" >> README.md
            echo "___" >> README.md
            echo "" >> README.md
            echo "## Validation Summary" >> README.md
            echo "" >> README.md
            echo "Ãšltima ejecuciÃ³n automÃ¡tica del sistema QCAL Auto-EvoluciÃ³n:" >> README.md
            echo "" >> README.md
            echo "| Property | Value |" >> README.md
            echo "|----------|-------|" >> README.md
            echo "| **Status** | - |" >> README.md
            echo "| **Build Time (s)** | - |" >> README.md
            echo "| **Warnings** | - |" >> README.md
            echo "| **Errors** | - |" >> README.md
            echo "| **Lean Version** | - |" >> README.md
            echo "| **Date (UTC)** | - |" >> README.md
            echo "" >> README.md
            echo "___" >> README.md
          fi
          
          # Actualizar la tabla con AWK
          awk -v status="$STATUS" -v time="$TIME" -v warn="$WARN" -v err="$ERR" -v leanv="$LEANV" -v date="$DATE" '
            BEGIN { inside=0; found=0 }
            /^## Validation Summary/ { inside=1; found=1; print; next }
            inside && /^\| Property \| Value \|/ {
              print
              print "|----------|-------|"
              print "| **Status** | " status " |"
              print "| **Build Time (s)** | " time " |"
              print "| **Warnings** | " warn " |"
              print "| **Errors** | " err " |"
              print "| **Lean Version** | " leanv " |"
              print "| **Date (UTC)** | " date " |"
              inside=0
              # Skip old table rows until we hit the separator
              while (getline && !/^___/ && !/^##/ && NF > 0) {}
              if (/^___/ || /^##/) print
              next
            }
            { print }
          ' README.md > README.tmp && mv README.tmp README.md
        fi

    - name: ğŸ§¾ Confirmar actualizaciÃ³n del README
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ“˜ Actualizar resumen de validaciÃ³n QCAL automÃ¡tica"
        branch: main

    # 7ï¸âƒ£ Informe final y energÃ­a simbiÃ³tica
    - name: â±ï¸ Resumen de evoluciÃ³n
      if: always()
      run: |
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "ğŸ§¬  CICLO QCAL COMPLETADO"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Repositorio     : motanova84/-jmmotaburr-riemann-adelic"
        echo "Fecha UTC       : $(date -u +"%Y-%m-%d %H:%M:%SZ")"
        REPORT="formalization/lean/validation_report.json"
        if [ -f "$REPORT" ]; then
          echo "Estado Resumen  : $(jq -r '.summary.status' $REPORT)"
          echo "Coherencia QCAL : $(jq -r '.summary.qcal_coherence' $REPORT)"
        else
          echo "Estado Resumen  : REPORT NOT FOUND"
        fi
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
